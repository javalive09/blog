---
title: 框架
date: 2017-02-11 09:42:15
tags:
---

# volley
## 1.请求
cache dispatcher     ---->       network dispatcher
1）如果 http请求的头信息中 的cache-control  max-age字段 未过期则使用 cache   ttl(time to live)存活时间
BasicNetwork.java
```
    @Override
    public NetworkResponse performRequest(Request<?> request) throws VolleyError {
        long requestStart = SystemClock.elapsedRealtime();
        while (true) {
            HttpResponse httpResponse = null;
            byte[] responseContents = null;
            Map<String, String> responseHeaders = Collections.emptyMap();
            try {
                // Gather headers.
                Map<String, String> headers = new HashMap<String, String>();
                addCacheHeaders(headers, request.getCacheEntry());
                ...
```
addCacheHeaders() 请求head会加入 "If-None-Match"（服务器上次返回的Last-Modified响应头中的日期值）， "If-Modified-Since"（服务器上次返回的ETag响应头的值）  进行条件请求，以便返回304
```
    private void addCacheHeaders(Map<String, String> headers, Cache.Entry entry) {
        // If there's no cache entry, we're done.
        if (entry == null) {
            return;
        }

        if (entry.etag != null) {
            headers.put("If-None-Match", entry.etag);
        }

        if (entry.lastModified > 0) {
            Date refTime = new Date(entry.lastModified);
            headers.put("If-Modified-Since", DateUtils.formatDate(refTime));
        }
    }

```

2）如果 max-age 过期 则先显示缓存再发network dispatcher 发netwokr请求 返回304／200 把缓存写入硬盘  返回结果



## 2. 缓存
二级缓存
1）DiskCache        
2）LruImageCache
## 3.重试
DefaultRetryPolicy   DEFAULT_MAX_RETRIES
## 4.超时
DefaultRetryPolicy  DEFAULT_TIMEOUT_MS
1）请求超时
2）接收数据超时
## 5.日志
VolleyLog

------

# retrofit
## 创建
```
new Retrofit.Builder()  
                .addConverterFactory(GsonConverterFactory.create())  
                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())  
                .build();  
```
## 流程
![](http://7xoxmg.com1.z0.glb.clouddn.com/retrofit.jpg)
